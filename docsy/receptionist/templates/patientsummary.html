{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Patient Summary</title>

    <style>
        .collapsible {
            background-color: #48bdc5;
            color: white;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }
        
        .active,
        .collapsible:hover {
            background-color: #319aa1;
        }
        
        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }
    </style>
</head>

<body>
    <div id="main-section">
        <!-- <a href="{% url 'patientSummaryView' %}">Submit</a> -->
        <div id="Patient-data">
            <button type="button" class="collapsible">Previous prescriptions</button>
            <div class="content">
                <div class="card-group table-responsive">

                    {% for each_data in problem_with_medicines %}
                    <br>
                    <h4>Disease Name: {{each_data.0.problem_name}}</h4>
                    <table id="example1" class="table table-striped table-bordered" style="width:80%; margin: auto;">
                        <thead>
                            <tr>
                                <td>medicine_name</td>
                                <td>form</td>
                                <td>strength</td>
                                <td>unit</td>
                                <td>diluent</td>
                                <td>diluent_amount</td>
                                <td>diluent_unit</td>
                                <td>dosade_directions</td>
                                <td>frequency</td>
                                <td>frequency_unit</td>
                                <td>interval</td>
                                <td>interval_unit</td>
                                <td>named_time_event</td>
                                <td>exact_timing_critical</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for medicine_data in each_data.1 %}
                            <tr>
                                <td>{{medicine_data.medicine_name}}</td>
                                <td>{{medicine_data.form}}</td>
                                <td>{{medicine_data.strength}}</td>
                                <td>{{medicine_data.strength_unit}}</td>
                                <td>{{medicine_data.diluent}}</td>
                                <td>{{medicine_data.diluent_amount}}</td>
                                <td>{{medicine_data.diluent_unit}}</td>
                                <td>{{medicine_data.dosade_directions}}</td>
                                <td>{{medicine_data.frequency}}</td>
                                <td>{{medicine_data.frequency_unit}}</td>
                                <td>{{medicine_data.interval}}</td>
                                <td>{{medicine_data.interval_unit}}</td>
                                <td>{{medicine_data.named_time_event}}</td>
                                <td>{{medicine_data.exact_timing_critical}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                </div>
                <br>
            </div>
            <button type="button" class="collapsible">Allergies</button>
            <div class="content table-responsive">
                <div class="card-group">
                    <table id="example1" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <td>substance</td>
                                <td>criticality</td>
                                <td>type</td>
                                <td>comment</td>

                            </tr>
                        </thead>
                        <tbody>
                            {% for data in allergy_data %}
                            <tr>
                                <td>{{data.substance}}</td>
                                <td>{{data.criticality}}</td>
                                <td>{{data.type}}</td>
                                <td>{{data.comment}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- </div> -->
                </div>
            </div>

            <button type="button" class="collapsible">History of Procedure</button>
            <div class="content table-responsive">
                <div class="card-group">
                    <table id="example1" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <td>procedure_name</td>
                                <td>body_site</td>
                                <td>severity</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in procedure_data %}
                            <tr>
                                <td>{{data.procedure_name}}</td>
                                <td>{{data.body_site}}</td>
                                <td>{{data.severity}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- </div> -->
                </div>
            </div>

            <button type="button" class="collapsible">History of Illness</button>
            <div class="content table-responsive">
                <div class="card-group">
                    <table id="example1" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <td>illness_name</td>
                                <td>body_site</td>
                                <td>severity</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in illness_data %}
                            <tr>
                                <td>{{data.illness_name}}</td>
                                <td>{{data.body_site}}</td>
                                <td>{{data.severity}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- </div> -->
                </div>
            </div>
        </div>

        <div id="diagnostic-data">
            <button type="button" class="collapsible">History of Diagnostics Data</button>
            <div class="content overflow-auto" style="margin-left: 50px; padding:0; height:300px">
                {% for each_data in all_details %}
                <h4>Doctor Name: {{each_data.0.name}}</h4>
                <button type="button" class="collapsible">Previous Lab Report</button>
                <div class="content table-responsive-md">
                    <div class="card-group">
                        <table id="example1" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <td>lab_event</td>
                                    <td>lab_test_name</td>
                                    <td>lab_specimen_type</td>
                                    <td>lab_specimen_method</td>
                                    <td>lab_specimen_body_site</td>
                                    <td>lab_findings</td>
                                    <td>lab_document</td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lab in each_data.1 %}
                                <tr>
                                    <td>{{lab.lab_event}}</td>
                                    <td>{{lab.lab_test_name}}</td>
                                    <td>{{lab.lab_specimen_type}}</td>
                                    <td>{{lab.lab_specimen_method}}</td>
                                    <td>{{lab.lab_specimen_body_site}}</td>
                                    <td>{{lab.lab_findings}}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- </div> -->
                    </div>
                </div>

                <button type="button" class="collapsible">Previous Image Report</button>
                <div class="content">
                    <div class="card-group">
                        <table id="example1" class="table table-striped table-bordered table-responsive" style="width:100%">
                            <thead>
                                <tr>
                                    <td>imaging_event</td>
                                    <td>imaging_test_name</td>
                                    <td>imaging_modality</td>
                                    <td>imaging_body_site</td>
                                    <td>imaging_findings</td>
                                    <td>imaging_document</td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for image in each_data.2 %}
                                <tr>
                                    <td>{{image.imaging_event}}</td>
                                    <td>{{image.imaging_test_name}}</td>
                                    <td>{{image.imaging_modality}}</td>
                                    <td>{{image.imaging_body_site}}</td>
                                    <td>{{image.imaging_findings}}</td>
                                    <td>
                                        <div class="text-center">
                                            <a class="btn btn-primary" href="imageView/{{image.imaging_document}}">View Report</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- </div> -->
                    </div>
                </div>
                {% endfor %}
            </div>


            <div>
                <!-- <p><span>Patient Name: {{patient_details.name}} </span> <span>Patient Age: {{patient_age}}</span></p> -->

                <!-- {% for each_data in all_details %}

                <div id="lab-report" class="card-group">
                    <div>
                        <p>View Lab Report</p><br/>
                        <p> Doctor Name: {{each_data.0.name}}</p>
                    </div>
                    {% for lab in each_data.1 %}
                    <div class="card ">
                        <div class="card-body canvas_div_pdf ">
                            <div class="canvas_div_pdflabimage"><img src="{{lab.lab_document.url}}" class="card-img-top " alt="Lab Report"></div>
                            <p class="card-text">{{lab.lab_event}}</p>
                            <p class="card-text">{{lab.lab_test_name}}</p>
                            <p class="card-text">{{lab.lab_specimen_type}}</p>
                            <p class="card-text">{{lab.lab_specimen_method}}</p>
                            <p class="card-text">{{lab.lab_specimen_body_site}}</p>
                            <p class="card-text">{{lab.lab_findings}}</p>
                        </div>

                        <button class="btn btn-success" onclick="getPDF()" id="downloadbtn" style="display: inline-block;"><b>Click to Download lab report</b></button>
                        <button class="btn btn-success" onclick="getPDFforlabimage()" id="downloadbtn" style="display: inline-block;"><b>Click to Download Lab report image</b></button>
                    </div>
                    {% endfor %}

                </div>

                <div id="image-report" class="card-group">
                    <div>
                        <p>View Image Report</p>
                        <p> Doctor Name: {{each_data.0.name}}</p>
                    </div>
                    {% for image in each_data.2 %}
                    <div class="card ">
                        <div class="card-body canvas_div_pdfimagereport">
                            <div class="canvas_div_pdfimage">
                                <img src="{{image.imaging_document.url}}" class="card-img-top" alt="Lab Report">
                            </div>
                            <p class="card-text">{{image.imaging_event}}</p>
                            <p class="card-text">{{image.imaging_test_name}}</p>
                            <p class="card-text">{{image.imaging_modality}}</p>
                            <p class="card-text">{{image.imaging_body_site}}</p>
                            <p class="card-text">{{image.imaging_findings}}</p>
                            <p class="card-text">{{image.imaging_document}}</p>

                            <div>
                                <button onclick="getPDF()" id="downloadbtn" style="display: inline-block;"><b>Click to Download HTML as PDF</b></button>
                                <button onclick="getPDF()" id="downloadbtn" style="display: inline-block;"><b>Click to Download HTML as PDF</b></button>
                            </div>
                        </div>
                    </div>

                    {% endfor %}
                </div>
                {% endfor %} -->
            </div>


        </div>
        <script>
            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                });
            }
        </script>
        <script>
            function getPDF() {
                var HTML_Width = $(".canvas_div_pdf").width();
                var HTML_Height = $(".canvas_div_pdf").height();
                var top_left_margin = 15;
                var PDF_Width = HTML_Width + (top_left_margin * 2);
                var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                var canvas_image_width = HTML_Width;
                var canvas_image_height = HTML_Height;

                var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;


                html2canvas($(".canvas_div_pdf")[0], {
                    allowTaint: true
                }).then(function(canvas) {
                    canvas.getContext('2d');

                    console.log(canvas.height + "  " + canvas.width);


                    var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);


                    for (var i = 1; i <= totalPDFPages; i++) {
                        pdf.addPage(PDF_Width, PDF_Height);
                        pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                    }

                    pdf.save("HTML-Document.pdf");
                });
            };

            function getPDFforlabimage() {
                var HTML_Width = $(".canvas_div_pdflabimage").width();
                var HTML_Height = $(".canvas_div_pdflabimage").height();
                var top_left_margin = 15;
                var PDF_Width = HTML_Width + (top_left_margin * 2);
                var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                var canvas_image_width = HTML_Width;
                var canvas_image_height = HTML_Height;

                var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;


                html2canvas($(".canvas_div_pdflabimage")[0], {
                    allowTaint: true
                }).then(function(canvas) {
                    canvas.getContext('2d');

                    console.log(canvas.height + "  " + canvas.width);


                    var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);


                    for (var i = 1; i <= totalPDFPages; i++) {
                        pdf.addPage(PDF_Width, PDF_Height);
                        pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                    }

                    pdf.save("HTML-Document.pdf");
                });
            };

            function getPDFforimagereport() {
                var HTML_Width = $(".canvas_div_pdfimagereport").width();
                var HTML_Height = $(".canvas_div_pdfimagereport").height();
                var top_left_margin = 15;
                var PDF_Width = HTML_Width + (top_left_margin * 2);
                var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                var canvas_image_width = HTML_Width;
                var canvas_image_height = HTML_Height;

                var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;


                html2canvas($(".canvas_div_pdfimagereport")[0], {
                    allowTaint: true
                }).then(function(canvas) {
                    canvas.getContext('2d');

                    console.log(canvas.height + "  " + canvas.width);


                    var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);


                    for (var i = 1; i <= totalPDFPages; i++) {
                        pdf.addPage(PDF_Width, PDF_Height);
                        pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                    }

                    pdf.save("HTML-Document.pdf");
                });
            };

            function getPDFforimage() {
                var HTML_Width = $(".canvas_div_pdfimage").width();
                var HTML_Height = $(".canvas_div_pdfimage").height();
                var top_left_margin = 15;
                var PDF_Width = HTML_Width + (top_left_margin * 2);
                var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                var canvas_image_width = HTML_Width;
                var canvas_image_height = HTML_Height;

                var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;


                html2canvas($(".canvas_div_pdfimage")[0], {
                    allowTaint: true
                }).then(function(canvas) {
                    canvas.getContext('2d');

                    console.log(canvas.height + "  " + canvas.width);


                    var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);


                    for (var i = 1; i <= totalPDFPages; i++) {
                        pdf.addPage(PDF_Width, PDF_Height);
                        pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height * i) + (top_left_margin * 4), canvas_image_width, canvas_image_height);
                    }

                    pdf.save("HTML-Document.pdf");
                });
            };
        </script>
</body>

</html>